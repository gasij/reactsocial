require('dotenv').config();
const http = require('http');
const { Server } = require('socket.io');
const { Pool } = require('pg');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const MessageHandler = require('./message-handler');
const authMiddleware = require('./middleware/auth');

const pool = new Pool({
    user: process.env.DB_USER,
    host: process.env.DB_HOST,
    database: process.env.DB_NAME,
    password: process.env.DB_PASSWORD,
    port: process.env.DB_PORT,
});

const generateToken = (userId) => {
    return jwt.sign({ id: userId }, process.env.JWT_SECRET, {
        expiresIn: process.env.JWT_EXPIRE
    });
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
const parseRequestBody = (req) => {
    return new Promise((resolve, reject) => {
        let body = '';
        req.on('data', chunk => body += chunk.toString());
        req.on('end', () => {
            try {
                resolve(JSON.parse(body));
            } catch (error) {
                reject(error);
            }
        });
    });
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ JSON –æ—Ç–≤–µ—Ç–∞
const sendJsonResponse = (res, statusCode, data) => {
    res.writeHead(statusCode, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify(data));
};

// –°–æ–∑–¥–∞–µ–º HTTP —Å–µ—Ä–≤–µ—Ä
const server = http.createServer(async (req, res) => {
    // CORS headers - —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ 3001 –ø–æ—Ä—Ç—É
    res.setHeader('Access-Control-Allow-Origin', 'http://localhost:3001');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, DELETE');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');
    res.setHeader('Access-Control-Allow-Credentials', 'true');
    
    if (req.method === 'OPTIONS') {
        res.writeHead(200);
        res.end();
        return;
    }

    const url = req.url;
    const method = req.method;

    console.log(`üì® ${method} ${url}`);

    try {
        // Health check
        if (url === '/api/health' && method === 'GET') {
            const result = await pool.query('SELECT 1');
            sendJsonResponse(res, 200, { 
                status: 'OK', 
                database: 'Connected',
                timestamp: new Date().toISOString()
            });
            return;
        }

        // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
        // Login endpoint
        if (url === '/api/auth/login' && method === 'POST') {
            try {
                const data = await parseRequestBody(req);
                const { email, password } = data;

                if (!email || !password) {
                    return sendJsonResponse(res, 400, { message: 'Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
                }

                const userResult = await pool.query(
                    'SELECT id, username, email, password FROM users WHERE email = $1',
                    [email]
                );

                if (userResult.rows.length === 0) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' });
                }

                const user = userResult.rows[0];
                const isPasswordValid = await bcrypt.compare(password, user.password);
                
                if (!isPasswordValid) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' });
                }

                const token = generateToken(user.id);
                sendJsonResponse(res, 200, {
                    message: '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!',
                    user: {
                        id: user.id,
                        username: user.username,
                        email: user.email
                    },
                    token: token
                });

            } catch (error) {
                console.error('Login error:', error);
                sendJsonResponse(res, 500, { 
                    message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
                    error: error.message 
                });
            }
            return;
        }

        // Register endpoint
        if (url === '/api/auth/register' && method === 'POST') {
            try {
                const data = await parseRequestBody(req);
                const { username, email, password } = data;

                if (!username || !email || !password) {
                    return sendJsonResponse(res, 400, { message: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
                }

                const hashedPassword = await bcrypt.hash(password, 10);
                const result = await pool.query(
                    `INSERT INTO users (username, email, password) 
                     VALUES ($1, $2, $3) 
                     RETURNING id, username, email, created_at`,
                    [username, email, hashedPassword]
                );

                const user = result.rows[0];
                const token = generateToken(user.id);

                sendJsonResponse(res, 201, {
                    message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!',
                    user: {
                        id: user.id,
                        username: user.username,
                        email: user.email,
                        createdAt: user.created_at
                    },
                    token: token
                });

            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === '23505') {
                    sendJsonResponse(res, 400, { message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –∏–ª–∏ username —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' });
                } else {
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
                }
            }
            return;
        }

        // ==================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ò –°–û–û–ë–©–ï–ù–ò–Ø ====================
        // Get users list
        if (url === '/api/users' && method === 'GET') {
            authMiddleware(req, async (error, userId) => {
                if (error) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
                }

                try {
                    const users = await messageHandler.getUsers(userId);
                    sendJsonResponse(res, 200, { users });
                } catch (error) {
                    console.error('Users error:', error);
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' });
                }
            });
            return;
        }

        // Send message
        if (url === '/api/messages/send' && method === 'POST') {
            authMiddleware(req, async (error, userId) => {
                if (error) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
                }

                try {
                    const data = await parseRequestBody(req);
                    const { receiver_id, message_text } = data;

                    if (!receiver_id || !message_text) {
                        return sendJsonResponse(res, 400, { message: 'receiver_id –∏ message_text –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
                    }

                    const message = await messageHandler.sendMessage(userId, receiver_id, message_text);
                    sendJsonResponse(res, 201, { 
                        message: '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                        message_data: message
                    });

                } catch (error) {
                    console.error('Send message error:', error);
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è' });
                }
            });
            return;
        }

        // Get conversation
        if (url.startsWith('/api/messages/') && method === 'GET') {
            authMiddleware(req, async (error, userId) => {
                if (error) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
                }

                try {
                    const other_user_id = url.split('/').pop();
                    const messages = await messageHandler.getConversation(userId, other_user_id);
                    sendJsonResponse(res, 200, { messages });
                } catch (error) {
                    console.error('Get messages error:', error);
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π' });
                }
            });
            return;
        }

        // ==================== DEBUG –≠–ù–î–ü–û–ò–ù–¢–´ ====================
        // Debug endpoint - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (url === '/api/debug/users' && method === 'GET') {
            try {
                const result = await pool.query('SELECT id, username, email, created_at FROM users ORDER BY id');
                console.log('üìä Users in database:', result.rows);
                
                sendJsonResponse(res, 200, { 
                    total: result.rows.length,
                    users: result.rows 
                });
            } catch (error) {
                console.error('Debug users error:', error);
                sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' });
            }
            return;
        }

        // Debug endpoint - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (url === '/api/debug/create-test-users' && method === 'POST') {
            try {
                console.log('üõ†Ô∏è Creating test users...');
                
                const testUsers = [
                    { username: 'alice', email: 'alice@example.com', password: 'password123' },
                    { username: 'bob', email: 'bob@example.com', password: 'password123' },
                    { username: 'charlie', email: 'charlie@example.com', password: 'password123' },
                    { username: 'diana', email: 'diana@example.com', password: 'password123' }
                ];

                let createdCount = 0;

                for (const user of testUsers) {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        const existingUser = await pool.query(
                            'SELECT id FROM users WHERE email = $1',
                            [user.email]
                        );

                        if (existingUser.rows.length === 0) {
                            const hashedPassword = await bcrypt.hash(user.password, 10);
                            await pool.query(
                                'INSERT INTO users (username, email, password) VALUES ($1, $2, $3)',
                                [user.username, user.email, hashedPassword]
                            );
                            createdCount++;
                            console.log(`‚úÖ Created user: ${user.username}`);
                        }
                    } catch (error) {
                        console.log(`‚ö†Ô∏è Error creating ${user.username}:`, error.message);
                    }
                }

                sendJsonResponse(res, 200, { 
                    message: `–°–æ–∑–¥–∞–Ω–æ ${createdCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`,
                    total: createdCount
                });

            } catch (error) {
                console.error('Create test users error:', error);
                sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' });
            }
            return;
        }

        // Debug endpoint - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (url === '/api/debug/create-test-messages' && method === 'POST') {
            authMiddleware(req, async (error, userId) => {
                if (error) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
                }

                try {
                    console.log('üí¨ Creating test messages...');
                    
                    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ
                    const usersResult = await pool.query(
                        'SELECT id FROM users WHERE id != $1 ORDER BY id',
                        [userId]
                    );
                    
                    const otherUsers = usersResult.rows;
                    if (otherUsers.length === 0) {
                        return sendJsonResponse(res, 400, { 
                            message: '–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π' 
                        });
                    }

                    const testMessages = [
                        { text: '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?', sender: userId, receiver: otherUsers[0].id },
                        { text: '–ü—Ä–∏–≤–µ—Ç! –í—Å–µ –æ—Ç–ª–∏—á–Ω–æ, –∞ —É —Ç–µ–±—è?', sender: otherUsers[0].id, receiver: userId },
                        { text: '–¢–æ–∂–µ —Ö–æ—Ä–æ—à–æ! –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?', sender: userId, receiver: otherUsers[0].id },
                        { text: '–ò–∑—É—á–∞—é WebSocket, –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!', sender: otherUsers[0].id, receiver: userId },
                        { text: '–≠—Ç–æ –∫—Ä—É—Ç–æ! –£ –º–µ–Ω—è —Ç–æ–∂–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è', sender: userId, receiver: otherUsers[0].id },
                        { text: '–ü–æ–∫–∞! –£–¥–∞—á–∏ —Å –ø—Ä–æ–µ–∫—Ç–æ–º!', sender: otherUsers[0].id, receiver: userId }
                    ];

                    let createdCount = 0;
                    const errors = [];

                    for (const msg of testMessages) {
                        try {
                            await pool.query(
                                `INSERT INTO messages (sender_id, receiver_id, message_text, timestamp) 
                                 VALUES ($1, $2, $3, NOW() - INTERVAL '${createdCount} minutes')`,
                                [msg.sender, msg.receiver, msg.text]
                            );
                            createdCount++;
                            console.log(`‚úÖ Created message: ${msg.text}`);
                        } catch (error) {
                            console.log(`‚ö†Ô∏è Error creating message:`, error.message);
                            errors.push(error.message);
                        }
                    }

                    sendJsonResponse(res, 200, { 
                        message: `–°–æ–∑–¥–∞–Ω–æ ${createdCount} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π`,
                        created: createdCount,
                        errors: errors.length > 0 ? errors : null
                    });

                } catch (error) {
                    console.error('Create test messages error:', error);
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π' });
                }
            });
            return;
        }

        // Debug endpoint - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (url === '/api/debug/messages' && method === 'GET') {
            authMiddleware(req, async (error, userId) => {
                if (error) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
                }

                try {
                    const result = await pool.query(`
                        SELECT m.*, 
                               s.username as sender_username,
                               r.username as receiver_username
                        FROM messages m
                        LEFT JOIN users s ON m.sender_id = s.id
                        LEFT JOIN users r ON m.receiver_id = r.id
                        ORDER BY m.timestamp DESC
                    `);
                    
                    console.log('üìã All messages in database:', result.rows);
                    
                    sendJsonResponse(res, 200, { 
                        total: result.rows.length,
                        messages: result.rows 
                    });
                } catch (error) {
                    console.error('Debug messages error:', error);
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π' });
                }
            });
            return;
        }

        // –ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
        sendJsonResponse(res, 404, { message: '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });

    } catch (error) {
        console.error('Server error:', error);
        sendJsonResponse(res, 500, { 
            message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
            error: error.message 
        });
    }
});

// ==================== WEB SOCKET –°–ï–†–í–ï–† ====================
const io = new Server(server, {
    cors: {
        origin: "http://localhost:3001",
        methods: ["GET", "POST"],
        credentials: true
    }
});

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä MessageHandler –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è io
const messageHandler = new MessageHandler(pool, io);

// Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ WebSocket
io.use((socket, next) => {
    const token = socket.handshake.auth.token;
    
    if (!token) {
        return next(new Error('Authentication error'));
    }

    jwt.verify(token, process.env.JWT_SECRET, (err, decoded) => {
        if (err) return next(new Error('Token invalid'));
        
        socket.userId = decoded.id;
        socket.join(decoded.id.toString());
        next();
    });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
io.on('connection', (socket) => {
    console.log('üîó User connected via WebSocket:', socket.userId);

    socket.on('disconnect', () => {
        console.log('üîå User disconnected:', socket.userId);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    socket.on('error', (error) => {
        console.error('WebSocket error:', error);
    });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log('====================================');
    console.log('üöÄ –°–ï–†–í–ï–† –ó–ê–ü–£–©–ï–ù');
    console.log('====================================');
    console.log(`üìç –ü–æ—Ä—Ç: ${PORT}`);
    console.log(`üåê HTTP: http://localhost:${PORT}`);
    console.log(`üîó WebSocket: ws://localhost:${PORT}`);
    console.log(`üéØ Frontend: http://localhost:3001`);
    console.log('====================================');
});
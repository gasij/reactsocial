require('dotenv').config();
const http = require('http');
const { Pool } = require('pg');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const MessageHandler = require('./message-handler');
const authMiddleware = require('./middleware/auth');

const pool = new Pool({
    user: process.env.DB_USER,
    host: process.env.DB_HOST,
    database: process.env.DB_NAME,
    password: process.env.DB_PASSWORD,
    port: process.env.DB_PORT,
});

const messageHandler = new MessageHandler();
const generateToken = (userId) => {
    return jwt.sign({ id: userId }, process.env.JWT_SECRET, {
        expiresIn: process.env.JWT_EXPIRE
    });
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
const parseRequestBody = (req) => {
    return new Promise((resolve, reject) => {
        let body = '';
        req.on('data', chunk => body += chunk.toString());
        req.on('end', () => {
            try {
                resolve(JSON.parse(body));
            } catch (error) {
                reject(error);
            }
        });
    });
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ JSON –æ—Ç–≤–µ—Ç–∞
const sendJsonResponse = (res, statusCode, data) => {
    res.writeHead(statusCode, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify(data));
};

const server = http.createServer(async (req, res) => {
    // CORS headers
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, DELETE');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');
    
    if (req.method === 'OPTIONS') {
        res.writeHead(200);
        res.end();
        return;
    }

    const url = req.url;
    const method = req.method;

    console.log(`üì® ${method} ${url}`);

    try {
        // Health check
        if (url === '/api/health' && method === 'GET') {
            const result = await pool.query('SELECT 1');
            sendJsonResponse(res, 200, { 
                status: 'OK', 
                database: 'Connected',
                timestamp: new Date().toISOString()
            });
            return;
        }

        // ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================
        // Login endpoint
        if (url === '/api/auth/login' && method === 'POST') {
            try {
                const data = await parseRequestBody(req);
                const { email, password } = data;

                if (!email || !password) {
                    return sendJsonResponse(res, 400, { message: 'Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
                }

                const userResult = await pool.query(
                    'SELECT id, username, email, password FROM users WHERE email = $1',
                    [email]
                );

                if (userResult.rows.length === 0) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' });
                }

                const user = userResult.rows[0];
                const isPasswordValid = await bcrypt.compare(password, user.password);
                
                if (!isPasswordValid) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' });
                }

                const token = generateToken(user.id);
                sendJsonResponse(res, 200, {
                    message: '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!',
                    user: {
                        id: user.id,
                        username: user.username,
                        email: user.email
                    },
                    token: token
                });

            } catch (error) {
                console.error('Login error:', error);
                sendJsonResponse(res, 500, { 
                    message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
                    error: error.message 
                });
            }
            return;
        }

        // Register endpoint
        if (url === '/api/auth/register' && method === 'POST') {
            try {
                const data = await parseRequestBody(req);
                const { username, email, password } = data;

                if (!username || !email || !password) {
                    return sendJsonResponse(res, 400, { message: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
                }

                const hashedPassword = await bcrypt.hash(password, 10);
                const result = await pool.query(
                    `INSERT INTO users (username, email, password) 
                     VALUES ($1, $2, $3) 
                     RETURNING id, username, email, created_at`,
                    [username, email, hashedPassword]
                );

                const user = result.rows[0];
                const token = generateToken(user.id);

                sendJsonResponse(res, 201, {
                    message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!',
                    user: {
                        id: user.id,
                        username: user.username,
                        email: user.email,
                        createdAt: user.created_at
                    },
                    token: token
                });

            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === '23505') {
                    sendJsonResponse(res, 400, { message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –∏–ª–∏ username —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' });
                } else {
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
                }
            }
            return;
        }

        // ==================== –°–û–û–ë–©–ï–ù–ò–Ø ====================
        // Get users list
        if (url === '/api/users' && method === 'GET') {
            authMiddleware(req, async (error, userId) => {
                if (error) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
                }

                try {
                    const users = await messageHandler.getUsers(userId);
                    sendJsonResponse(res, 200, { users });
                } catch (error) {
                    console.error('Users error:', error);
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' });
                }
            });
            return;
        }

        // Send message
        if (url === '/api/messages/send' && method === 'POST') {
            authMiddleware(req, async (error, userId) => {
                if (error) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
                }

                try {
                    const data = await parseRequestBody(req);
                    const { receiver_id, message_text } = data;

                    if (!receiver_id || !message_text) {
                        return sendJsonResponse(res, 400, { message: 'receiver_id –∏ message_text –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
                    }

                    const message = await messageHandler.sendMessage(userId, receiver_id, message_text);
                    sendJsonResponse(res, 201, { 
                        message: '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                        message_data: message
                    });

                } catch (error) {
                    console.error('Send message error:', error);
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è' });
                }
            });
            return;
        }

        // Get conversation
        if (url.startsWith('/api/messages/') && method === 'GET') {
            authMiddleware(req, async (error, userId) => {
                if (error) {
                    return sendJsonResponse(res, 401, { message: '–ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' });
                }

                try {
                    const other_user_id = url.split('/').pop();
                    const messages = await messageHandler.getConversation(userId, other_user_id);
                    sendJsonResponse(res, 200, { messages });
                } catch (error) {
                    console.error('Get messages error:', error);
                    sendJsonResponse(res, 500, { message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π' });
                }
            });
            return;
        }

        // ==================== DEBUG –≠–ù–î–ü–û–ò–ù–¢–´ ====================
        // Debug endpoint - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (url === '/api/debug/users' && method === 'GET') {
            try {
                const result = await pool.query('SELECT id, username, email, created_at FROM users ORDER BY id');
                console.log('üìä Users in database:', result.rows);
                
                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ 
                    total: result.rows.length,
                    users: result.rows 
                }));
            } catch (error) {
                console.error('Debug users error:', error);
                res.writeHead(500, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ message: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' }));
            }
            return;
        }

        // Debug endpoint - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (url === '/api/debug/create-test-users' && method === 'POST') {
            try {
                console.log('üõ†Ô∏è Creating test users...');
                
                const testUsers = [
                    { username: 'alice', email: 'alice@example.com', password: 'password123' },
                    { username: 'bob', email: 'bob@example.com', password: 'password123' },
                    { username: 'charlie', email: 'charlie@example.com', password: 'password123' },
                    { username: 'diana', email: 'diana@example.com', password: 'password123' }
                ];

                let createdCount = 0;

                for (const user of testUsers) {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        const existingUser = await pool.query(
                            'SELECT id FROM users WHERE email = $1',
                            [user.email]
                        );

                        if (existingUser.rows.length === 0) {
                            const hashedPassword = await bcrypt.hash(user.password, 10);
                            await pool.query(
                                'INSERT INTO users (username, email, password) VALUES ($1, $2, $3)',
                                [user.username, user.email, hashedPassword]
                            );
                            createdCount++;
                            console.log(`‚úÖ Created user: ${user.username}`);
                        }
                    } catch (error) {
                        console.log(`‚ö†Ô∏è Error creating ${user.username}:`, error.message);
                    }
                }

                res.writeHead(200, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ 
                    message: `–°–æ–∑–¥–∞–Ω–æ ${createdCount} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`,
                    total: createdCount
                }));

            } catch (error) {
                console.error('Create test users error:', error);
                res.writeHead(500, { 'Content-Type': 'application/json' });
                res.end(JSON.stringify({ message: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' }));
            }
            return;
        }

        // –ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
        sendJsonResponse(res, 404, { message: '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });

    } catch (error) {
        console.error('Server error:', error);
        sendJsonResponse(res, 500, { 
            message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
            error: error.message 
        });
    }
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
    console.log('====================================');
    console.log('üöÄ –°–ï–†–í–ï–† –ó–ê–ü–£–©–ï–ù');
    console.log('====================================');
    console.log(`üìç –ü–æ—Ä—Ç: ${PORT}`);
    console.log(`üåê URL: http://localhost:${PORT}`);
    console.log('====================================');
});